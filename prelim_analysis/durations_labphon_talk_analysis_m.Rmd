---
title: "Taiwanese Mandarin / Korean / Kapampangan / English / Vietnamese articulation rate vs. rhythm"
author: "Márton Sóskuthy & Roger Lo"
output: html_document
---

Shared data processing pipeline for the four Ls.

```{r}
library(tidyverse)
library(ggbeeswarm)
library(ggpubr)
library(geomtextpath)

twm <- read_csv("../data/taiwanese_mandarin_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  filter(speaker != "mn_tw_66") %>%
  select(-sex, -age) %>%
  mutate(language="Taiwan Mandarin",
         folder="taiwanese_mandarin")
k <- read_csv("../data/korean_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  select(-sex, -age) %>%
  mutate(language="Seoul Korean",
         folder="korean")
p <- read_csv("../data/kapampangan_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  select(-sex, -age) %>%
  mutate(language="Kapampangan",
         folder="kapampangan")
v <- read_csv("../data/vietnamese_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  #select(-sex, -age) %>%
  mutate(language="Vietnamese",
         speaker=as.character(speaker),
         folder="vietnamese")
s <- read_csv("../data/swahili_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  #select(-sex, -age) %>%
  mutate(language="Swahili",
         speaker=as.character(speaker),
         folder="swahili")
tu <- read_csv("../data/turkish_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  #select(-sex, -age) %>%
  mutate(language="Turkish",
         speaker=as.character(speaker),
         folder="turkish")
a <- read_csv("../data/amharic_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  #select(-sex, -age) %>%
  mutate(language="Amharic",
         speaker=as.character(speaker),
         folder="amharic")
g <- read_csv("../data/georgian_durations.csv") %>%
  arrange(speaker, file, phone_start) %>%
  #select(-sex, -age) %>%
  mutate(language="Georgian",
         speaker=as.character(speaker),
         folder="georgian")
b <- readRDS("../data/buckeye_durations.rds") %>%
  arrange(speaker, file, phone_start) %>%
  mutate(language="American English",
    segment_type=case_when(
      phone %in% c("{E_TRANS}", "{B_TRANS}", "id", "no", "hhn", "an") ~ "non-speech",
      phone %in% c("a", "e", "ih l", "ah r", "i", "ah l", "ah ix", "uw ix", "ah n") ~ "vowel",
      TRUE ~ segment_type
    )
  )

d <- bind_rows(twm, k, p, b, v, s, tu, a, g)
```

Coding consonant type.

```{r}
d <- d %>%
  mutate(
    c_type = case_when(
      ## Taiwan Mandarin
      language == "Taiwan Mandarin" & 
        phone %in% c("p", "b", "t", "d", "k", "g") ~ "stop",
      language == "Taiwan Mandarin" & 
        phone %in% c("f", "sh", "s", "x", "h") ~ "fricative",
      language == "Taiwan Mandarin" & 
        phone %in% c("j", "q", "zh", "ch", "z", "c") ~ "affricate",
      language == "Taiwan Mandarin" & 
        phone %in% c("m", "n", "ng") ~ "nasal",
      language == "Taiwan Mandarin" & 
        phone %in% c("y", "w", "ue") ~ "approximant",
      language == "Taiwan Mandarin" & 
        phone %in% c("l", "r") ~ "liquid",
      language == "Taiwan Mandarin" & 
        phone %in% c("i","ii","v","u") ~ "high vowel",
      ## Korean
      language == "Seoul Korean" & 
        phone %in% c("B", "Ph", "BB", "p", "D", "Th", "DD", "t", "G", "Kh", "GG", "k") ~ "stop",
      language == "Seoul Korean" & 
        phone %in% c("S", "SS", "H") ~ "fricative",
      language == "Seoul Korean" & 
        phone %in% c("J", "CHh", "JJ") ~ "affricate",
      language == "Seoul Korean" & 
        phone %in% c("M", "N", "NG") ~ "nasal",
      language == "Seoul Korean" & 
        phone %in% c("L", "R") ~ "liquid",
      language == "Seoul Korean" & 
        phone %in% c("I","U","EU","UE","iU","euI") ~ "high vowel",
      ## Kapampangan
      language == "Kapampangan" & 
        phone %in% c("b", "p", "d", "t", "ɡ", "k", "ʔ", "q", "c") ~ "stop",
      language == "Kapampangan" & 
        phone %in% c("s", "ʃ", "f", "h", "v", "x") ~ "fricative",
      language == "Kapampangan" & 
        phone %in% c("tʃ", "dʒ") ~ "affricate",
      language == "Kapampangan" & 
        phone %in% c("m", "n", "ŋ") ~ "nasal",
      language == "Kapampangan" & 
        phone %in% c("j", "w") ~ "approximant",
      language == "Kapampangan" & 
        phone %in% c("l", "r") ~ "liquid",
      language == "Kapampangan" & 
        phone %in% c("i", "ɪ", "u", "ʊ") ~ "high vowel",
      ## American English
      language == "American English" &
        phone %in% c("p", "b", "t", "d", "k", "g", "dx", "q", "tq") ~ "stop",
      language == "American English" &
        phone %in% c("m", "n", "ng", "nx") ~ "nasal",
      language == "American English" &
        phone %in% c("f", "v", "th", "dh", "s", "z", "sh", "zh", "hh", "h", "x") ~ "fricative",
      language == "American English" &
        phone %in% c("ch", "jh", "j") ~ "affricate",
      language == "American English" &
        phone %in% c("r", "l") ~ "liquid",
      language == "American English" &
        phone %in% c("w", "y") ~ "approximant",
      language == "American English" &
        phone %in% c("em", "en", "el", "eng") ~ "syllabic C",
      language == "American English" & 
        phone %in% c("ih", "iy", "uw", "ihn", "uhn", "iyn", "uwn") ~ "high vowel",
      ## Vietnamese
      language == "Vietnamese" &
        phone %in% c("p", "t", "c", "k", "tʰ", "ɓ", "ɗ", "ʔ") ~ "stop",
      language == "Vietnamese" &
        phone %in% c("m", "n", "ɲ", "ŋ") ~ "nasal",
      language == "Vietnamese" &
        phone %in% c("f", "v", "s", "z", "x", "ɣ", "h") ~ "fricative",
      language == "Vietnamese" &
        phone %in% c("tɕ") ~ "affricate",
      language == "Vietnamese" &
        phone %in% c("l") ~ "liquid",
      language == "Vietnamese" &
        phone %in% c("w", "j") ~ "approximant",
      language == "Vietnamese" & 
        phone %in% (unique(filter(v, segment_type=="vowel")$phone) %>% str_subset("^[iɨu][^ə]")) ~ "high vowel",
      ## Swahili
      language == "Swahili" &
        phone %in% c('b', 'd', 'k', 'p', 't', 'ɓ', 'ɗ', 'ɠ', 'ɡ', 'ʄ') ~ "stop",
      language == "Swahili" &
        phone %in% c('m', 'n', 'ŋ', 'ɱ', 'ɲ') ~ "nasal",
      language == "Swahili" &
        phone %in% c('f', 'h', 's', 'v', 'z', 'ð', 'ɣ', 'ʃ', 'θ') ~ "fricative",
      language == "Swahili" &
        phone %in% c('dʒ', 'tʃ') ~ "affricate",
      language == "Swahili" &
        phone %in% c("l", "ɾ") ~ "liquid",
      language == "Swahili" &
        phone %in% c("w", "j") ~ "approximant",
      language == "Swahili" & 
        phone %in% c("i","u","iː","uː") ~ "high vowel",
      ## Turkish
      language == "Turkish" &
        phone %in% c('b', 'bː', 'c', 'cː', 'd̪', 'd̪ː','k', 'kː', 'p','t̪', 't̪ː', 'ɟ', 'ɡ') ~ "stop",
      language == "Turkish" &
        phone %in% c('m', 'mː', 'n̪', 'n̪ː','ŋ') ~ "nasal",
      language == "Turkish" &
        phone %in% c('f', 'h', 'hː', 's̪', 's̪ː','v', 'z̪','ç','ʃ','ʒ') ~ "fricative",
      language == "Turkish" &
        phone %in% c('dʒ', 'tʃ') ~ "affricate",
      language == "Turkish" &
        phone %in% c('ɾ','ɫ', 'ɫː', 'ʎ', 'ʎː') ~ "liquid",
      language == "Turkish" &
        phone %in% c("j") ~ "approximant",
      language == "Turkish" & 
        phone %in% c("i","ɯ","u","y","iː","ɯː","uː","yː","ɨ","ʏ") ~ "high vowel",
      ## Georgian
      language == "Georgian" &
        phone %in% c('b', 'd', 'kʰ', 'kʼ', 'pʰ', 'pʼ', 'qʼ', 'tʰ', 'tʼ', 'ɡ') ~ "stop",
      language == "Georgian" &
        phone %in% c('m', 'n') ~ "nasal",
      language == "Georgian" &
        phone %in% c('h', 's', 'v', 'x', 'z', 'ɣ', 'ʃ', 'ʒ') ~ "fricative",
      language == "Georgian" &
        phone %in% c('dz', 'dʒ', 'ts', 'tsʼ', 'tʃ', 'tʃʼ') ~ "affricate",
      language == "Georgian" &
        phone %in% c('ɾ', 'l') ~ "liquid",
      language == "Georgian" &
        phone %in% c('i', 'u') ~ "high vowel",
      ## Amharic
      language == "Amharic" &
        phone %in% c('p', 'pʷ', 'pʼ', 'pʷʼ', 'b', 'pʷ', 't', 'tʷ', 'tʼ', 'tʷʼ', 'd', 'dʷ', 'k', 'kʷ', 'kʼ', 'kʷʼ', 'ɡ', 'ɡʷ', 'ʔ') ~ "stop",
      language == "Amharic" &
        phone %in% c('m', 'mʷ', 'n', 'nʷ', 'ɲ', 'ɲʷ') ~ "nasal",
      language == "Amharic" &
        phone %in% c('v', 'vʷ', 'f', 'fʷ', 's', 'sʷ', 'sʼ', 'sʷʼ', 'z', 'zʷ', 'ʃ', 'ʃʷ', 'ʒ', 'ʒʷ', 'h', 'hʷ') ~ "fricative",
      language == "Amharic" &
        phone %in% c('t͡ʃ', 't͡ʃʷ', 't͡ʃʼ', 't͡ʃʷʼ', 'd͡ʒ', 'd͡ʒʷ') ~ "affricate",
      language == "Amharic" &
        phone %in% c('r', 'rʷ', 'l', 'lʷ') ~ "liquid",
      language == "Amharic" &
        phone %in% c('w', 'j') ~ "approximant",
      language == "Amharic" &
        phone %in% c('i', 'u', "ɨ") ~ "high vowel"#,
      #segment_type == "vowel" &  ~ "vowel"
    ),
    c_type=ifelse(is.na(c_type), "NA", c_type),
    c_type=ifelse(segment_type=="vowel" & (c_type!="high vowel"),  "non-high vowel", c_type)
  )

# check phonemes
d %>%
  filter(c_type == "approximant", language == "American English") %>%
  pull(phone) %>%
  unique()
```

Grouping by utterance, creating predictors.

```{r}
# for checking

d_check <- d %>%
  filter(segment_type %in% c("consonant", "vowel"),
         phone_dur > 0)

# for analysis
d_uttr <- d %>%
  filter(segment_type %in% c("consonant", "vowel"),
         phone_dur > 0) %>%
  group_by(
    language,
    speaker,
    uttr_id
  ) %>%
  summarise(
    # duration of segmental material only
    uttr_dur = sum(phone_dur),
    num_syllables_uttr = sum(segment_type=="vowel" | c_type=="syllabic C"),
    num_segments_uttr = n(),
    segment_dur_uttr = uttr_dur / num_segments_uttr,
    syllable_dur_uttr = uttr_dur / num_syllables_uttr,
    vowel_dur_uttr = mean(phone_dur[segment_type=="vowel"]),
    cons_dur_uttr = mean(phone_dur[segment_type=="consonant"]),
    nh_v_dur = mean(phone_dur[c_type=="non-high vowel"]),
    h_v_dur = mean(phone_dur[c_type=="high vowel"]),
    stop_dur = mean(phone_dur[c_type == "stop"]),
    fricative_dur = mean(phone_dur[c_type == "fricative"]),
    affricate_dur = mean(phone_dur[c_type == "affricate"]),
    nasal_dur = mean(phone_dur[c_type == "nasal"]),
    approximant_dur = mean(phone_dur[c_type == "approximant"]),
    liquid_dur = mean(phone_dur[c_type == "liquid"]),
    syllabic_c_dur = mean(phone_dur[c_type == "syllabic C"]),
    perc_v = 100 * sum(phone_dur[segment_type=="vowel"]) / uttr_dur
  ) %>%
  ungroup()
```

Some data filtering.

```{r paper}
# this part is just to see the number of tokens in each cat
d_uttr %>% 
  #nrow()
  
  filter(num_syllables_uttr > 5) %>%
  filter(segment_dur_uttr < 0.25) %>%
  filter(segment_dur_uttr > 0.04) %>%
  #nrow()
  
  filter(
    log(segment_dur_uttr) > 
      mean(log(segment_dur_uttr)) - 
      3*sd(log(segment_dur_uttr)),
    log(segment_dur_uttr) < 
      mean(log(segment_dur_uttr)) +
      3*sd(log(segment_dur_uttr))
  ) #%>%
  #nrow()
```

Actual filtering
```{r}
d_uttr <- d_uttr %>% 
  filter(num_syllables_uttr > 5) %>%
  filter(segment_dur_uttr < 0.25) %>%
  filter(segment_dur_uttr > 0.04) %>%
  filter(
    log(segment_dur_uttr) > 
      mean(log(segment_dur_uttr)) - 
      3*sd(log(segment_dur_uttr)),
    log(segment_dur_uttr) < 
      mean(log(segment_dur_uttr)) +
      3*sd(log(segment_dur_uttr))
  )
```

set.seed(321)
d_check_final <- filter(d_check, uttr_id %in% d_uttr$uttr_id) %>%
  filter(!(language %in% c("Kapampangan"))) %>%
  mutate(phone_id=paste(language,file,phone_start),
         word_id=paste(language,file,word_start)) %>%
  group_by(word_id) %>%
  mutate(word_trs = paste0(phone, collapse="")) %>%
  ungroup() %>%
  group_by(language, speaker) %>%
  filter(phone_id %in% c(
    sample(phone_id[segment_type=="vowel"], 10, replace=F),
    sample(phone_id[segment_type=="consonant"], 10, replace=F)
  )) %>%
  ungroup() %>%
  mutate(phone_alignment=NA,
         phone_quality=NA,
         comment=NA) %>%
  select(language, folder, speaker, file, 
         word, word_trs, word_start, word_end, 
         phone, segment_type, phone_start, phone_end,
         phone_alignment, phone_quality, comment)

write_csv(d_check_final, "spot_checking_calibration_full.csv")
Get the frequency of different segment types
```{r}
included_uttr <- unique(d_uttr$uttr_id)

d_c_freq <- d %>%
  dplyr::filter(uttr_id %in% included_uttr) %>%
  group_by(language, c_type) %>%
  count() %>%
  dplyr::filter(c_type != "NA") %>%
  group_by(language) %>%
  mutate(
    prop = n / sum(n)
  )

d_c_freq %>%
  mutate(
    c_type = fct_relevel(c_type,
    "syllabic C", "stop", "affricate", "fricative", "liquid", "nasal", "approximant", "non-high vowel", "high-vowel"
    )
    #"high vowel", "non-high vowel", "approximant", "nasal", "liquid", "fricative", "affricate", "stop", "syllabic C")
  ) %>%
  ggplot(aes(x = c_type, y = prop)) +
  geom_bar(stat = "identity") +
  facet_wrap(. ~ language) +
  coord_flip()
```

Get numbers for paper
```{r paper}
# get some numbers for the paper
d_uttr %>%
  group_by(language) %>%
  summarize(
    N = length(unique(uttr_id)),
    DUR = sum(uttr_dur)/60/60
  )

unique(d_uttr$speaker)
```

Exploratory plots!

```{r}
ggplot(d_uttr, aes(x=segment_dur_uttr, y=perc_v)) +
  facet_wrap(~language) +
  geom_point() +
  geom_smooth(method="gam") +
  ylab("V%") +
  xlab("average segment duration (1 / speech rate)")

ggplot(d_uttr, aes(x=segment_dur_uttr)) +
  facet_wrap(~language) +
  geom_point(aes(y=vowel_dur_uttr), col="orange", alpha=0.3) +
  geom_point(aes(y=cons_dur_uttr), col="purple", alpha=0.3) +
  geom_smooth(aes(y=vowel_dur_uttr), col="darkorange2", method="gam", se=F) +
  geom_smooth(aes(y=cons_dur_uttr), col="purple4", method="gam", se=F) +
  ylab("average duration in s") +
  scale_x_log10() +
  scale_y_log10()
```

GAMMs!

```{r}
library(mgcv)
library(itsadug)

# %V model

d_uttr_perc_v <- d_uttr

d_uttr_perc_v$speaker_f <- as.factor(d_uttr_perc_v$speaker)
d_uttr_perc_v$language_f <- as.factor(d_uttr_perc_v$language)
d_uttr_perc_v$log_segment_dur_uttr <- log(d_uttr_perc_v$segment_dur_uttr)

#range(d_uttr_perc_v$perc_v)
#range(d_uttr_perc_v$log_segment_dur_uttr)
#length(unique(d_uttr_perc_v$speaker))
#length(unique(d_uttr_perc_v$language))

perc_v_mod <- bam(perc_v ~ s(log_segment_dur_uttr, bs = "cr") +
  s(log_segment_dur_uttr, speaker_f, bs = "fs", xt = list("cr"), m=1) +
  s(log_segment_dur_uttr, language_f, bs = "fs", m = 1, xt = list("cr")),
  data = d_uttr_perc_v,
  discrete = TRUE,
  nthreads = 8
)
summary(perc_v_mod)
saveRDS(perc_v_mod, "perc_v_mod.rds")

# C/V model - we need to move to long data format!
d_uttr_cv <- pivot_longer(
  d_uttr,
  cols = c("vowel_dur_uttr", "cons_dur_uttr"),
  names_to = "segment_type",
  values_to = "avg_dur"
)

d_uttr_cv$segment_type_o <- as.ordered(d_uttr_cv$segment_type)
contrasts(d_uttr_cv$segment_type_o) <- "contr.treatment"
d_uttr_cv$speaker_f <- as.factor(d_uttr_cv$speaker)
d_uttr_cv$speakerSegtype <- interaction(d_uttr_cv$speaker, d_uttr_cv$segment_type)
d_uttr_cv$language_f <- as.factor(d_uttr_cv$language)
d_uttr_cv$languageSegtype <- interaction(d_uttr_cv$language, d_uttr_cv$segment_type)
d_uttr_cv$log_segment_dur_uttr <- log(d_uttr_cv$segment_dur_uttr)
d_uttr_cv$log_avg_dur <- log(d_uttr_cv$avg_dur)
cv_mod <- bam(log_avg_dur ~
  segment_type_o +
  s(log_segment_dur_uttr, bs = "cr") +
  s(log_segment_dur_uttr, by = segment_type_o, bs = "cr") +
  #s(segment_dur_uttr, speaker_f, bs="fs", xt=list("cr"), m=1) +
  s(log_segment_dur_uttr, speakerSegtype, bs = "fs", m = 1, xt = list("cr")) +
  #s(segment_dur_uttr, language_f, bs="fs", m=1, xt=list("cr")) +
  s(log_segment_dur_uttr, languageSegtype, bs = "fs", m = 1, xt = list("cr")),
  data = d_uttr_cv,
  discrete = TRUE,
  nthreads=8
)
summary(cv_mod)
saveRDS(cv_mod, "cv_mod.rds")

# c_type model
d_uttr_ctype <- pivot_longer(
  d_uttr,
  cols = c("nh_v_dur", "h_v_dur",  "stop_dur",
        "fricative_dur", "affricate_dur",
        "nasal_dur", "liquid_dur",
        "approximant_dur"),
  names_to = "segment_type",
  values_to = "avg_dur"
)

d_uttr_ctype$segment_type_f <- as.factor(d_uttr_ctype$segment_type)
d_uttr_ctype$speaker_f <- as.factor(d_uttr_ctype$speaker)
d_uttr_ctype$language_f <- as.factor(d_uttr_ctype$language)
d_uttr_ctype$languageSegtype <- interaction(d_uttr_ctype$language_f,
                                            d_uttr_ctype$segment_type_f)
d_uttr_ctype$log_segment_dur_uttr <- log(d_uttr_ctype$segment_dur_uttr)
d_uttr_ctype$log_avg_dur <- log(d_uttr_ctype$avg_dur)
ctype_mod <- bam(log_avg_dur ~
  segment_type_f +
  s(log_segment_dur_uttr, by = segment_type_f, bs = "cr") +
  s(log_segment_dur_uttr, speaker_f, bs = "fs", m = 1, xt = list("cr")) +
  s(log_segment_dur_uttr, languageSegtype, bs = "fs", m = 1, xt = list("cr")),
  data = d_uttr_ctype,
  discrete = TRUE, nthreads = 8
)

#summary(ctype_mod)
saveRDS(ctype_mod, "ctype_mod.rds")
```

## Prediction plots: languages

Make a combined data set: added columns of language + pivoting based on measure. Measures: v_prop, v_dur, c_dur.

```{r}
d_uttr_plot <- d_uttr %>%
  pivot_longer(c(perc_v, vowel_dur_uttr, cons_dur_uttr),
               names_to="measure",
               values_to="value") %>%
  mutate(measure_type = ifelse(measure=="perc_v", "perc_v", "dur"),
         measure_type = factor(measure_type, levels=c("perc_v", "dur")),
         measure = factor(measure, levels=c("perc_v", "vowel_dur_uttr", "cons_dur_uttr"))
  )
```

Make separate V% and C/V duration plots (9 Ls is too much to combine in one!).

```{r}
# model predictions
newdat_cv <- expand.grid(
  log_segment_dur_uttr = seq(
    min(d_uttr_cv$log_segment_dur_uttr),
    max(d_uttr_cv$log_segment_dur_uttr),
    length.out = 100
  ),
  #speaker_f=d_uttr_cv$speaker_f[1],
  speakerSegtype = d_uttr_cv$speakerSegtype[1],
  #language_f=unique(d_uttr_cv$language_f),
  languageSegtype = unique(d_uttr_cv$languageSegtype),
  measure_type = "dur"
)

newdat_cv$segment_type_o <- str_extract(newdat_cv$languageSegtype, "[^.]*$")
newdat_cv$segment_type_o <- as.ordered(newdat_cv$segment_type_o)
contrasts(newdat_cv$segment_type_o) <- "contr.treatment"

newdat_cv$language <- str_extract(newdat_cv$languageSegtype, "^[^.]*")
newdat_cv$language_f <- as.factor(newdat_cv$language)
newdat_cv$speaker_f <- as.factor(str_extract(newdat_cv$speakerSegtype, "^[^.]*"))
#newdat_cv$speaker_f <- d_uttr_cv$speaker_f[1]

preds <- predict(cv_mod, newdat_cv,
  # the following is used when predicting without speakers
  exclude=c("s(log_segment_dur_uttr,speakerSegtype)",
            "s(log_segment_dur_uttr,speaker_f)", "s(log_segment_dur_uttr,speaker_f):segment_type_ovowel_dur_uttr"),
  se.fit = TRUE
)

newdat_cv$value <- exp(preds$fit)
newdat_cv$ul <- exp(preds$fit + preds$se.fit * 1.96)
newdat_cv$ll <- exp(preds$fit - preds$se.fit * 1.96)

newdat_cv$segment_dur_uttr <- exp(newdat_cv$log_segment_dur_uttr)
```

Predictions for V percentage
```{r}
newdat_perc_v <- filter(newdat_cv, segment_type_o == "cons_dur_uttr")
newdat_perc_v$measure_type <- "perc_v"
newdat_perc_v$speaker_f <- d_uttr_perc_v$speaker_f[1]

preds <- predict(perc_v_mod, newdat_perc_v,
                 exclude=c("s(log_segment_dur_uttr,speaker_f)"),
                 se.fit = TRUE
)

newdat_perc_v$value <- preds$fit
newdat_perc_v$ul <- preds$fit + preds$se.fit * 1.96
newdat_perc_v$ll <- preds$fit - preds$se.fit * 1.96

newdat <- bind_rows(newdat_cv, newdat_perc_v)
newdat$segment_dur_uttr <- exp(newdat$log_segment_dur_uttr)
```

Predictions that include random effects
```{r}
# new dataframe that includes participants
newdat_cv <- expand_grid(
  log_segment_dur_uttr = seq(
    min(d_uttr_cv$log_segment_dur_uttr),
    max(d_uttr_cv$log_segment_dur_uttr),
    length.out = 100
  ),
  d_uttr_cv %>%
      select(speakerSegtype, languageSegtype) %>%
      unique(),
  measure_type = "dur"
)

preds <- predict(cv_mod, newdat_cv, se.fit = TRUE)

newdat_cv$value <- exp(preds$fit)
newdat_cv$ul <- exp(preds$fit + preds$se.fit * 1.96)
newdat_cv$ll <- exp(preds$fit - preds$se.fit * 1.96)

newdat_cv$segment_dur_uttr <- exp(newdat_cv$log_segment_dur_uttr)
newdat_cv %>% write_csv("newdat_cv.csv")

LANG = "Amharic"
d_uttr_plot %>%
  filter(measure_type == "dur", language == LANG) %>%
  ggplot(data = ., aes(x = segment_dur_uttr, y = value, col = measure)) +
  facet_wrap(. ~ speaker_f) +
  geom_point(alpha = 0.1) +
  geom_ribbon(data = filter(newdat_cv,
                            measure_type == "dur",
                            segment_type_o == "vowel_dur_uttr",
                            language == LANG),
              aes(ymin = ll, ymax = ul), col = NA, fill = "grey",
              alpha = 0.5) +
  geom_ribbon(data = filter(newdat_cv,
                            measure_type == "dur",
                            segment_type_o == "cons_dur_uttr",
                            language == LANG),
              aes(ymin = ll, ymax = ul), col = NA, fill = "grey",
              alpha = 0.5) +
  geom_line(data = filter(newdat_cv,
                          measure_type == "dur",
                          segment_type_o == "vowel_dur_uttr",
                          language == LANG),
            col = "darkorange1", lwd = 1) +
  geom_line(data = filter(newdat_cv,
                          measure_type == "dur",
                          segment_type_o == "cons_dur_uttr",
                          language == LANG),
            col = "purple4", lwd = 1) +
  scale_x_log10(breaks = c(0.05, 0.07, 0.1, 0.14)) +
  scale_y_log10(breaks = c(0.05, 0.07, 0.1, 0.14),
                limits = c(0.03, 0.19)) +
  #scale_x_continuous(limits=c(0.035,0.145), 
  #                   breaks=seq(0.04,0.14,0.02),
  #                   labels=c(".04",".06",".08",".10",".12",".14")) +
  scale_colour_manual(values = c("orange", "purple"), guide = "none") +
  #scale_y_continuous(breaks=seq(0.04,0.20,0.02)) +
    # labels for axes
  xlab("Average segment duration in s (inverse speech rate)") +
  labs(y = "Average C vs. V duration in s") +
  #ylab("Average V vs. C duration in s") +
  # remove clutter
  theme_minimal()
```

```{r}
newdat_perc_v <- filter(newdat_cv, segment_type_o == "cons_dur_uttr")
newdat_perc_v$measure_type <- "perc_v"

preds <- predict(perc_v_mod, newdat_perc_v, se.fit = TRUE)

newdat_perc_v$value <- preds$fit
newdat_perc_v$ul <- preds$fit + preds$se.fit * 1.96
newdat_perc_v$ll <- preds$fit - preds$se.fit * 1.96

newdat_perc_v %>% write_csv("newdat_perc_v.csv")

newdat <- bind_rows(newdat_cv, newdat_perc_v)
newdat$segment_dur_uttr <- exp(newdat$log_segment_dur_uttr)

newdat_perc_v %>%
  filter(language == "Turkish") %>%
  ggplot(aes(x = log_segment_dur_uttr, y = value), data = .) +
  geom_ribbon(aes(ymin = ll, ymax = ul), alpha = 0.25) +
  geom_line() +
  facet_wrap(. ~ speaker_f)
```

We now obtain a measure of effect strength: the difference in the log-log derivative at the median speech rate / language. Based on model predictions!

```{r}
# model predictions
newdat_deriv <- expand.grid(
  #log_segment_dur_uttr=0,
  #speaker_f=d_uttr_cv$speaker_f[1],
  speakerSegtype=d_uttr_cv$speakerSegtype[1],
  #language_f=unique(d_uttr_cv$language_f),
  languageSegtype=unique(d_uttr_cv$languageSegtype),
  measure_type="dur"
)

newdat_deriv$segment_type_o <- str_extract(newdat_deriv$languageSegtype,
                                        "[^.]*$")
newdat_deriv$segment_type_o <- as.ordered(newdat_deriv$segment_type_o)
contrasts(newdat_deriv$segment_type_o) <- "contr.treatment"

newdat_deriv$language <- str_extract(newdat_deriv$languageSegtype,
                                        "^[^.]*")
newdat_deriv$language_f <- as.factor(newdat_deriv$language)
newdat_deriv$speaker_f <- d_uttr_cv$speaker_f[1]

language_med_durs <- d_uttr_cv %>%
  group_by(language) %>%
  summarise(log_segment_dur_uttr=median(log_segment_dur_uttr)) %>%
  ungroup()

newdat_deriv <- left_join(
  newdat_deriv,
  language_med_durs,
  by="language"
)

preds <- predict(cv_mod, 
                 newdat_deriv, 
                 exclude=c("s(log_segment_dur_uttr,speakerSegtype)",
                   "s(log_segment_dur_uttr,speaker_f)", "s(log_segment_dur_uttr,speaker_f):segment_type_ovowel_dur_uttr"),
                 se.fit=T
)


eps <- 0.001

newdat_deriv_1 <- newdat_deriv %>%
  mutate(log_segment_dur_uttr = log_segment_dur_uttr - (eps/2)
  )
newdat_deriv_2 <- newdat_deriv %>%
  mutate(log_segment_dur_uttr = log_segment_dur_uttr + (eps/2)
  )

X0 <- predict(cv_mod, 
              newdat_deriv_1, type = 'lpmatrix', 
              exclude=c("s(log_segment_dur_uttr,speakerSegtype)",
                        "s(log_segment_dur_uttr,speaker_f)",
                        "s(log_segment_dur_uttr,speaker_f):segment_type_ovowel_dur_uttr")
              )
X1 <- predict(cv_mod, 
              newdat_deriv_2, type = 'lpmatrix', 
              exclude=c("s(log_segment_dur_uttr,speakerSegtype)",
                        "s(log_segment_dur_uttr,speaker_f)",
                        "s(log_segment_dur_uttr,speaker_f):segment_type_ovowel_dur_uttr")
              )

# finite difference approximation of first derivative
# the design matrix
Xp <- (X1 - X0) / eps
first_deriv <- Xp %*% coef(cv_mod)

newdat_deriv$derivative <- first_deriv
eff_sizes <- newdat_deriv %>%
  dplyr::select(language, segment_type_o, log_segment_dur_uttr, derivative) %>%
  group_by(language, log_segment_dur_uttr) %>%
  summarise(eff_size = derivative[segment_type_o=="vowel_dur_uttr"] - derivative[segment_type_o=="cons_dur_uttr"]) %>%
  ungroup() %>%
  arrange(desc(eff_size))
#eff_sizes_order <- eff_sizes$eff_size
#names(eff_sizes_order) <- eff_sizes$language
```

We now order by effect size & show this number in the plot.

```{r}
newdat$language <- factor(newdat$language, levels=eff_sizes$language)
d_uttr_plot$language <- factor(d_uttr_plot$language, levels=eff_sizes$language)
eff_sizes$language <- factor(eff_sizes$language, levels=eff_sizes$language)
eff_sizes$segment_dur_uttr <- 0.05
eff_sizes$value <- 0.13

# plot
ggplot(filter(d_uttr_plot, measure_type=="perc_v"), aes(x=segment_dur_uttr, y=value)) +
  facet_wrap(. ~ language, ncol=3) +
  geom_point(alpha=0.3) +
  geom_ribbon(data=filter(newdat, 
                          measure_type=="perc_v"),
              aes(ymin=ll,ymax=ul), col=NA, fill="grey",
              alpha=0.5) +
  geom_line(data=filter(newdat, 
                        measure_type=="perc_v"), 
            col="blue", lwd=1) +
  scale_x_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  ylim(0,100) +
  #scale_x_continuous(limits=c(0.035,0.145), 
  #                   breaks=seq(0.04,0.14,0.02),
  #                   labels=c(".04",".06",".08",".10",".12",".14")) +
  # labels for axes
  #xlab("Average segment duration in s (inverse speech rate)") +
  labs(y="%V", x="Average segment duration in s (inverse speech rate)") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size=0.8),
        axis.ticks = element_line(size=0.8),
        axis.text = element_text(size=16, colour="black"),
        axis.title = element_text(size=18, face="bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text=element_text(size=18, face="bold"))
ggsave("graphs_labphon/percentage_v.png", width=9, height=9, dpi=300)

ggplot(filter(d_uttr_plot, measure_type == "perc_v"),
       aes(x = segment_dur_uttr, y = value)) +
  facet_wrap(. ~ language, ncol = 3) +
  geom_point(alpha = 0.3) +
  geom_ribbon(data = filter(newdat, measure_type=="perc_v"),
              aes(ymin = ll,ymax = ul), col = NA, fill = "grey",
              alpha = 0.5) +
  geom_line(data = filter(newdat, measure_type == "perc_v"), 
            col = "blue", lwd = 1) +
  scale_x_log10(breaks = c(0.05, 0.07, 0.1, 0.14)) +
  ylim(0,100) +
  #scale_x_continuous(limits=c(0.035,0.145), 
  #                   breaks=seq(0.04,0.14,0.02),
  #                   labels=c(".04",".06",".08",".10",".12",".14")) +
  # labels for axes
  labs(y = "%V", x = "Average segment duration in s (inverse speech rate)") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size = 0.5),
        axis.ticks = element_line(size = 0.5),
        axis.text = element_text(size = 8, colour = "black"),
        axis.title = element_text(size = 10, face = "bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text = element_text(size = 10, face = "bold"))

ggsave("graphs_labphon/percentage_v.pdf", width = 150, height = 150, dpi = 300, units = "mm")
ggsave("graphs_labphon/percentage_v.tiff", width = 150, height = 150, dpi = 300, units = "mm")


ggplot(filter(d_uttr_plot, measure_type=="dur"), aes(x=segment_dur_uttr, y=value, col=measure)) +
  facet_wrap(. ~ language, ncol=3) +
  geom_point(alpha=0.1) +
  geom_ribbon(data=filter(newdat,
                          measure_type=="dur",
                          segment_type_o=="vowel_dur_uttr"),
              aes(ymin=ll,ymax=ul), col=NA, fill="grey",
              alpha=0.5) +
  geom_ribbon(data=filter(newdat,
                          measure_type=="dur",
                          segment_type_o=="cons_dur_uttr"),
              aes(ymin=ll,ymax=ul), col=NA, fill="grey",
              alpha=0.5) +
  geom_line(data=filter(newdat,
                        measure_type=="dur",
                        segment_type_o=="vowel_dur_uttr"),
            col="darkorange1", lwd=1) +
  geom_line(data=filter(newdat,
                        measure_type=="dur",
                        segment_type_o=="cons_dur_uttr"),
            col="purple4", lwd=1) +
  geom_text(data=eff_sizes, aes(label=paste0("Δβ = ", round(eff_size,2))),
            col="black", size=5) +
  scale_x_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  scale_y_log10(breaks=c(0.05, 0.07, 0.1, 0.14),
                limits=c(0.03,0.19)) +
  #scale_x_continuous(limits=c(0.035,0.145), 
  #                   breaks=seq(0.04,0.14,0.02),
  #                   labels=c(".04",".06",".08",".10",".12",".14")) +
  scale_colour_manual(values=c("orange", "purple"), guide="none") +
  #scale_y_continuous(breaks=seq(0.04,0.20,0.02)) +
    # labels for axes
  xlab("Average segment duration in s (inverse speech rate)") +
  labs(y="Average C vs. V duration in s") +
  #ylab("Average V vs. C duration in s") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size=0.8),
        axis.ticks = element_line(size=0.8),
        axis.text = element_text(size=16, colour="black"),
        axis.title = element_text(size=18, face="bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text=element_text(size=18, face="bold"))
#ggarrange(plot_a, plot_b,
#          ncol=1, nrow=2,
#          align="v")
ggsave("graphs_labphon/cv.png", width=9, height=9, dpi=300)

ggplot(filter(d_uttr_plot, measure_type=="dur"), aes(x=segment_dur_uttr, y=value, col=measure)) +
  facet_wrap(. ~ language, ncol=3) +
  geom_point(alpha=0.1) +
  geom_ribbon(data=filter(newdat,
                          measure_type=="dur",
                          segment_type_o=="vowel_dur_uttr"),
              aes(ymin=ll,ymax=ul), col=NA, fill="grey",
              alpha=0.5) +
  geom_ribbon(data=filter(newdat,
                          measure_type=="dur",
                          segment_type_o=="cons_dur_uttr"),
              aes(ymin=ll,ymax=ul), col=NA, fill="grey",
              alpha=0.5) +
  geom_line(data=filter(newdat,
                        measure_type=="dur",
                        segment_type_o=="vowel_dur_uttr"),
            col="darkorange1", lwd=1) +
  geom_line(data=filter(newdat,
                        measure_type=="dur",
                        segment_type_o=="cons_dur_uttr"),
            col="purple4", lwd=1) +
  #geom_text(data=eff_sizes, aes(label = paste0("Δβ = ", round(eff_size,2))),
  #          col="black", size=5) +
  geom_text(data=eff_sizes, aes(label = paste0("\u0394\u03b2 = ",round(eff_size,2))),
            col="black", size = 3) +
  scale_x_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  scale_y_log10(breaks=c(0.05, 0.07, 0.1, 0.14),
                limits=c(0.03,0.19)) +
  #scale_x_continuous(limits=c(0.035,0.145), 
  #                   breaks=seq(0.04,0.14,0.02),
  #                   labels=c(".04",".06",".08",".10",".12",".14")) +
  scale_colour_manual(values=c("orange", "purple"), guide="none") +
  #scale_y_continuous(breaks=seq(0.04,0.20,0.02)) +
    # labels for axes
  xlab("Average segment duration in s (inverse speech rate)") +
  labs(y="Average C vs. V duration in s") +
  #ylab("Average V vs. C duration in s") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size = 0.5),
        axis.ticks = element_line(size = 0.5),
        axis.text = element_text(size = 8, colour = "black"),
        axis.title = element_text(size = 10, face = "bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text = element_text(size = 10, face = "bold"))

ggsave("graphs_labphon/cv.pdf", width = 150, height = 150, dpi = 300, units = "mm",
       device = cairo_pdf)
ggsave("graphs_labphon/cv.tiff", width = 150, height = 150, dpi = 300, units = "mm")
```

## Prediction plot: overall

Overall prediction plot.

```{r}
# model predictions
newdat <- expand.grid(
  log_segment_dur_uttr=seq(
    min(d_uttr_cv$log_segment_dur_uttr),
    max(d_uttr_cv$log_segment_dur_uttr),
    length.out=100
  ),
  speaker_f=d_uttr_cv$speaker_f[1],
  speakerSegtype=d_uttr_cv$speakerSegtype[1],
  language_f=d_uttr_cv$language_f[1],
  languageSegtype=d_uttr_cv$languageSegtype[1],
  segment_type_o=unique(d_uttr_cv$segment_type_o)
)
  
preds <- predict(cv_mod, 
                 newdat, 
                 exclude=c("s(log_segment_dur_uttr,speakerSegtype)",
                           "s(log_segment_dur_uttr,languageSegtype)",
                   "s(segment_dur_uttr,language_f)", "s(segment_dur_uttr,language_f):segment_type_ovowel_dur_uttr",
                   "s(segment_dur_uttr,speaker_f)", "s(segment_dur_uttr,speaker_f):segment_type_ovowel_dur_uttr"),
                 se.fit=T
)

newdat$value <- exp(preds$fit)
newdat$avg_dur_ul <- exp(preds$fit + preds$se.fit * 1.96)
newdat$avg_dur_ll <- exp(preds$fit - preds$se.fit * 1.96)

newdat$segment_dur_uttr <- exp(newdat$log_segment_dur_uttr)
newdat$segment_type <-
  case_when(
    newdat$segment_type_o == "cons_dur_uttr" ~ "C",
    TRUE ~ "V",
  )

# plot
ggplot(newdat, aes(x=segment_dur_uttr, y=value, col=segment_type)) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type), size = 6, vjust = 0.2,
                linewidth = 1) +
  scale_x_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  scale_y_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Average segment duration in s\n(inverse speech rate)") +
  labs(y=NULL) +
  ylab("Average C vs. V duration") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size=0.8),
        axis.ticks = element_line(size=0.8),
        axis.text = element_text(size=14, colour="black"),
        axis.title = element_text(size=16, face="bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text=element_text(size=16, face="bold"))
ggsave("graphs_labphon/labphon_cv_mod_preds.png", width=5, height=5, dpi=300)

ggplot(newdat, aes(x=segment_dur_uttr, y=value, col=segment_type)) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type), size = 5, vjust = 0.2,
                linewidth = 1) +
  scale_x_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  scale_y_log10(breaks=c(0.05, 0.07, 0.1, 0.14)) +
  scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Average segment duration in s\n(inverse speech rate)") +
  ylab("Average C vs. V duration") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size = 0.5),
        axis.ticks = element_line(size = 0.5),
        axis.text = element_text(size = 8, colour = "black"),
        axis.title = element_text(size = 10, face = "bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text = element_text(size = 10, face = "bold"))

ggsave("graphs_labphon/labphon_cv_mod_preds.pdf", width = 75, height = 75, dpi = 300, units = "mm")
ggsave("graphs_labphon/labphon_cv_mod_preds.tiff", width = 75, height = 75, dpi = 300, units = "mm")
```

## Prediction plot: ctype

Generating new data to plot.

```{r}
# model predictions
newdat <- expand.grid(
  log_segment_dur_uttr=seq(
    min(d_uttr_ctype$log_segment_dur_uttr),
    max(d_uttr_ctype$log_segment_dur_uttr),
    length.out=100
  ),
  speaker_f=d_uttr_ctype$speaker_f[1],
  languageSegtype=unique(d_uttr_ctype$languageSegtype)[1],
  segment_type_f=unique(d_uttr_ctype$segment_type_f)
)
  
preds <- predict(ctype_mod, 
                 newdat, 
                 exclude=c("s(log_segment_dur_uttr,languageSegtype)",
                           "s(log_segment_dur_uttr,speaker_f)"),
                 se.fit=T
)

newdat$value <- preds$fit
newdat$avg_dur_ul <- preds$fit + preds$se.fit * 1.96
newdat$avg_dur_ll <- preds$fit - preds$se.fit * 1.96
newdat$segment_dur_uttr <- exp(newdat$log_segment_dur_uttr)

newdat$segment_type <- str_extract(newdat$segment_type_f, "^[^_]*")
newdat$segment_type <- recode(
  newdat$segment_type,
  approximant="glide",
  nh="non-high vowel",
  h="high vowel",
)
newdat$segment_type_broad <- 
  case_when(
    newdat$segment_type %in% c("non-high vowel", "high vowel", "glide") ~ "vocalic",
    newdat$segment_type %in% c("liquid", "nasal", "fricative") ~ "continuant + nasal",
    newdat$segment_type %in% c("affricate", "stop") ~ "non-continuant",
  )
newdat$segment_type_broad <- 
  factor(newdat$segment_type_broad,
         levels=c("vocalic", "continuant + nasal", "non-continuant"))

newdat_ctype$segment_type <- str_extract(newdat_ctype$segment_type_f, "^[^_]*")
newdat_ctype$segment_type <- recode(
  newdat_ctype$segment_type,
  approximant="glide",
  nh="non-high vowel",
  h="high vowel",
)
newdat_ctype$segment_type_broad <- 
  case_when(
    newdat_ctype$segment_type %in% c("non-high vowel", "high vowel", "glide") ~ "vocalic",
    newdat_ctype$segment_type %in% c("liquid", "nasal", "fricative") ~ "continuant + nasal",
    newdat_ctype$segment_type %in% c("affricate", "stop") ~ "non-continuant",
  )
newdat_ctype$segment_type_broad <- 
  factor(newdat_ctype$segment_type_broad,
         levels=c("vocalic", "continuant + nasal", "non-continuant"))




newdat_ctype %>%
mutate(language = str_extract(languageSegtype, "^[^.]*")) %>%
ggplot(aes(x = log_segment_dur_uttr, y = value, col = segment_type_f)) +
  facet_wrap(. ~ language) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type_f), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type), size = 3, vjust = 0.2,
                linewidth = 1) +
  scale_x_continuous(breaks=c(-3.5,-3,-2.5,-2),
                    labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_y_continuous(breaks=c(-3.5,-3,-2.5,-2),
                    labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_colour_brewer(palette = "Set1", guide='none') +
  scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Overall average segment duration in s (inverse speech rate)") +
  ylab("Average duration per segment type") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size = 0.5),
        axis.ticks = element_line(size = 0.5),
        axis.text = element_text(size = 8, colour = "black"),
        axis.title = element_text(size = 10, face = "bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text = element_text(size = 10, face = "bold"))

```

Predictions including random effects
```{r}
# new data for c types, including speakers
newdat_ctype <- expand_grid(
  log_segment_dur_uttr = seq(
    min(d_uttr_ctype$log_segment_dur_uttr),
    max(d_uttr_ctype$log_segment_dur_uttr),
    length.out = 100
  ),
  d_uttr_ctype %>%
      select(speaker_f, languageSegtype, segment_type_f) %>%
      unique()
)

preds <- predict(ctype_mod, newdat_ctype, se.fit = TRUE)

#Warning message:
#In predict.gam(object, newdata = newdata, type = "newdata", se.fit = se.fit,  :
#  factor levels Georgian.approximant_dur, Seoul Korean.approximant_dur not in original fit

newdat_ctype <- newdat_ctype %>%
  dplyr::filter(
    languageSegtype != "Georgian.approximant_dur",
    languageSegtype != "Seoul Korean.approximant_dur"
  )

newdat_ctype$value <- preds$fit
newdat_ctype$avg_dur_ul <- preds$fit + preds$se.fit * 1.96
newdat_ctype$avg_dur_ll <- preds$fit - preds$se.fit * 1.96
newdat_ctype$segment_dur_uttr <- exp(newdat_ctype$log_segment_dur_uttr)

newdat$segment_type <- str_extract(newdat$segment_type_f, "^[^_]*")
newdat$segment_type <- recode(
  newdat$segment_type,
  approximant="glide",
  nh="non-high vowel",
  h="high vowel",
)
newdat$segment_type_broad <- 
  case_when(
    newdat$segment_type %in% c("non-high vowel", "high vowel", "glide") ~ "vocalic",
    newdat$segment_type %in% c("liquid", "nasal", "fricative") ~ "continuant + nasal",
    newdat$segment_type %in% c("affricate", "stop") ~ "non-continuant",
  )
newdat$segment_type_broad <- 
  factor(newdat$segment_type_broad,
         levels=c("vocalic", "continuant + nasal", "non-continuant"))


newdat_ctype$segment_type <- str_extract(newdat_ctype$segment_type_f, "^[^_]*")
newdat_ctype$segment_type <- recode(
  newdat_ctype$segment_type,
  approximant="glide",
  nh="non-high vowel",
  h="high vowel",
)
newdat_ctype$segment_type_broad <- 
  case_when(
    newdat_ctype$segment_type %in% c("non-high vowel", "high vowel", "glide") ~ "vocalic",
    newdat_ctype$segment_type %in% c("liquid", "nasal", "fricative") ~ "continuant + nasal",
    newdat_ctype$segment_type %in% c("affricate", "stop") ~ "non-continuant",
  )
newdat_ctype$segment_type_broad <- 
  factor(newdat_ctype$segment_type_broad,
         levels=c("vocalic", "continuant + nasal", "non-continuant"))

newdat_ctype %>% write_csv("newdat_ctype.csv")

speakers <- newdat_ctype %>%
  mutate(language = str_extract(languageSegtype, "^[^.]*")) %>%
  group_by(language) %>%
  sample_n(1) %>%
  pull(speaker_f)


newdat_ctype <- read_csv("./newdat_ctype.csv")
newdat_ctype %>%
mutate(language = str_extract(languageSegtype, "^[^.]*")) %>%
filter(speaker_f %in% speakers) %>%
ggplot(aes(x = log_segment_dur_uttr, y = value, col = segment_type_f)) +
  facet_wrap(. ~ language) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type_f), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type), size = 3, vjust = 0.2,
                linewidth = 1) +
  #scale_x_continuous(breaks=c(-3.5,-3,-2.5,-2),
  #                   labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  #scale_y_continuous(breaks=c(-3.5,-3,-2.5,-2),
  #                   labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  #scale_colour_brewer(palette = "Set1", guide='none') +
  #scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Overall average segment duration in s (inverse speech rate)") +
  ylab("Average duration per segment type") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size = 0.5),
        axis.ticks = element_line(size = 0.5),
        axis.text = element_text(size = 8, colour = "black"),
        axis.title = element_text(size = 10, face = "bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text = element_text(size = 10, face = "bold"))
```

Here, looking at the average slope between the 10th to 90th percentiles of data would be helpful.

```{r}
# model predictions
newdat_deriv <- expand.grid(
  quantile=seq(0.1, 0.9, 0.01),
  speaker_f=d_uttr_ctype$speaker_f[1],
  languageSegtype=unique(d_uttr_ctype$languageSegtype)[1],
  segment_type_f=unique(d_uttr_ctype$segment_type_f)
)

ctype_quant_durs <- d_uttr_ctype %>%
  group_by(segment_type_f) %>%
  summarise(quantile=seq(0.1, 0.9, 0.01),
            log_segment_dur_uttr=quantile(log_segment_dur_uttr, quantile)) %>%
  ungroup()

newdat_deriv <- left_join(
  newdat_deriv,
  ctype_quant_durs,
  by=c("segment_type_f", "quantile")
)

eps <- 0.001

newdat_deriv_1 <- newdat_deriv %>%
  mutate(log_segment_dur_uttr = log_segment_dur_uttr - (eps/2)
  )
newdat_deriv_2 <- newdat_deriv %>%
  mutate(log_segment_dur_uttr = log_segment_dur_uttr + (eps/2)
  )

X0 <- predict(ctype_mod, 
              newdat_deriv_1, type = 'lpmatrix', 
              exclude=c("s(log_segment_dur_uttr,languageSegtype)",
                           "s(log_segment_dur_uttr,speaker_f)")
              )
X1 <- predict(ctype_mod, 
              newdat_deriv_2, type = 'lpmatrix', 
              exclude=c("s(log_segment_dur_uttr,languageSegtype)",
                           "s(log_segment_dur_uttr,speaker_f)")
              )

# finite difference approximation of first derivative
# the design matrix
Xp <- (X1 - X0) / eps
first_deriv <- Xp %*% coef(ctype_mod)

newdat_deriv$derivative <- first_deriv
ctype_eff_sizes <- newdat_deriv %>%
  group_by(segment_type_f) %>%
  summarise(eff_size = mean(derivative)) %>%
  ungroup() %>%
  arrange(desc(eff_size))

ctype_eff_sizes
```

Direct label the plot with these figures?

```{r}
newdat <- left_join(newdat, ctype_eff_sizes, by="segment_type_f")
newdat$segment_type_eff = paste0(newdat$segment_type, ", \u03b2 = ", round(newdat$eff_size, 2))

ggplot(newdat, aes(x=log_segment_dur_uttr, y=value, col=segment_type_f)) +
  facet_wrap(~segment_type_broad) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type_f), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type_eff), size = 5, vjust = 0.2,
                linewidth = 1) +
  scale_x_continuous(breaks=c(-3.5,-3,-2.5,-2),
                     labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_y_continuous(breaks=c(-3.5,-3,-2.5,-2),
                     labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_colour_brewer(palette = "Set1", guide='none') +
  #scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Overall average segment duration in s (inverse speech rate)") +
  labs(y=NULL) +
  ylab("Average duration per segment type") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size=0.8),
        axis.ticks = element_line(size=0.8),
        axis.text = element_text(size=14, colour="black"),
        axis.title = element_text(size=16, face="bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text=element_text(size=16, face="bold"))
ggsave("graphs_labphon/labphon_ctype_mod_preds.png", width=7.5, height=4, dpi=300)

ggplot(newdat, aes(x=log_segment_dur_uttr, y=value, col=segment_type_f)) +
  facet_wrap(~segment_type_broad) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type_f), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type_eff), size = 3, vjust = 0.2,
                linewidth = 1) +
  scale_x_continuous(breaks=c(-3.5,-3,-2.5,-2),
                     labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_y_continuous(breaks=c(-3.5,-3,-2.5,-2),
                     labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_colour_brewer(palette = "Set1", guide='none') +
  #scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Overall average segment duration in s (inverse speech rate)") +
  ylab("Average duration per segment type") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size = 0.5),
        axis.ticks = element_line(size = 0.5),
        axis.text = element_text(size = 8, colour = "black"),
        axis.title = element_text(size = 10, face = "bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text = element_text(size = 10, face = "bold"))

ggsave("graphs_labphon/labphon_ctype_mod_preds.pdf", width = 150, height = 75, dpi = 300, units = "mm", device = cairo_pdf)
ggsave("graphs_labphon/labphon_ctype_mod_preds.tiff", width = 150, height = 75, dpi = 300, units = "mm")
```

## Turkish only

```{r}
turkish_perc_v_mod <- bam(perc_v ~ 
                s(log_segment_dur_uttr, bs="cr") +
                s(log_segment_dur_uttr, speaker_f, bs="fs", xt=list("cr"), m=1),
              data=filter(d_uttr_perc_v, language=="Turkish"),
              discrete=T, nthreads=8
          )
summary(turkish_perc_v_mod)

turkish_cv_mod <- bam(log_avg_dur ~ 
                segment_type_o +
                s(log_segment_dur_uttr, bs="cr") +
                s(log_segment_dur_uttr, by=segment_type_o, bs="cr") +
                s(log_segment_dur_uttr, speakerSegtype, bs="fs", m=1, xt=list("cr")),
              data=filter(d_uttr_cv, language=="Turkish"),
              discrete=T, nthreads=8
          )
summary(turkish_cv_mod)

turkish_ctype_mod <- bam(log_avg_dur ~ 
                segment_type_f +
                s(log_segment_dur_uttr, by=segment_type_f, bs="cr") +
                s(log_segment_dur_uttr, speaker_f, bs="fs", m=1, xt=list("cr")),
              data=filter(d_uttr_ctype, language=="Turkish"),
              discrete=T, nthreads=8
          )
```

Turkish ctype plot.

```{r}
# model predictions
newdat <- expand.grid(
  log_segment_dur_uttr=seq(
    min(filter(d_uttr_ctype, language=="Turkish")$log_segment_dur_uttr),
    max(filter(d_uttr_ctype, language=="Turkish")$log_segment_dur_uttr),
    length.out=100
  ),
  speaker_f=filter(d_uttr_ctype, language=="Turkish")$speaker_f[1],
  segment_type_f=unique(filter(d_uttr_ctype, language=="Turkish")$segment_type_f)
)
  
preds <- predict(turkish_ctype_mod, 
                 newdat, 
                 exclude=c("s(log_segment_dur_uttr,speaker_f)"),
                 se.fit=T
)

newdat$value <- preds$fit
newdat$avg_dur_ul <- preds$fit + preds$se.fit * 1.96
newdat$avg_dur_ll <- preds$fit - preds$se.fit * 1.96
newdat$segment_dur_uttr <- exp(newdat$log_segment_dur_uttr)

newdat$segment_type <- str_extract(newdat$segment_type_f, "^[^_]*")
newdat$segment_type <- recode(
  newdat$segment_type,
  approximant="glide",
  nh="non-high vowel",
  h="high vowel",
)
newdat$segment_type_broad <- 
  case_when(
    newdat$segment_type %in% c("non-high vowel", "high vowel", "glide") ~ "vocalic",
    newdat$segment_type %in% c("liquid", "nasal", "fricative") ~ "continuant + nasal",
    newdat$segment_type %in% c("affricate", "stop") ~ "non-continuant",
  )
newdat$segment_type_broad <- 
  factor(newdat$segment_type_broad,
         levels=c("vocalic", "continuant + nasal", "non-continuant"))

ggplot(newdat, aes(x=log_segment_dur_uttr, y=value, col=segment_type_f)) +
  facet_wrap(~segment_type_broad) +
  geom_ribbon(aes(ymin=avg_dur_ll,ymax=avg_dur_ul, group=segment_type_f), col=NA, fill="grey",
              alpha=0.3) +
  geom_textline(aes(label = segment_type), size = 5, vjust = 0.2,
                linewidth = 1) +
  scale_x_continuous(breaks=c(-3.5,-3,-2.5,-2),
                     labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_y_continuous(breaks=c(-3.5,-3,-2.5,-2),
                     labels=round(exp(c(-3.5,-3,-2.5,-2)),2)) +
  scale_colour_brewer(palette = "Set1", guide='none') +
  #scale_colour_manual(values=c("purple4", "darkorange2"), guide="none") +
  xlab("Overall average segment duration in s (inverse speech rate)") +
  labs(y=NULL) +
  ylab("Average duration per segment type") +
  # remove clutter
  theme_minimal() +
  # some specific formatting...
  theme(panel.grid = element_blank(),
        axis.line = element_line(size=0.8),
        axis.ticks = element_line(size=0.8),
        axis.text = element_text(size=14, colour="black"),
        axis.title = element_text(size=16, face="bold"),
        strip.background.y = element_blank(), 
        strip.placement = "outside",
        strip.text=element_text(size=16, face="bold"))
ggsave("graphs_labphon/labphon_turkish_ctype_mod_preds.png", width=7.5, height=4, dpi=300)
```

Turkish derivatives...

```{r}
# model predictions
turkish_newdat_deriv <- expand.grid(
  quantile=seq(0.1, 0.9, 0.01),
  speaker_f=filter(d_uttr_ctype, language=="Turkish")$speaker_f[1],
  languageSegtype=unique(filter(d_uttr_ctype, language=="Turkish")$languageSegtype)[1],
  segment_type_f=unique(filter(d_uttr_ctype, language=="Turkish")$segment_type_f)
)

ctype_quant_durs <- filter(d_uttr_ctype, language=="Turkish") %>%
  group_by(segment_type_f) %>%
  summarise(quantile=seq(0.1, 0.9, 0.01),
            log_segment_dur_uttr=quantile(log_segment_dur_uttr, quantile)) %>%
  ungroup()

turkish_newdat_deriv <- left_join(
  turkish_newdat_deriv,
  ctype_quant_durs,
  by=c("segment_type_f", "quantile")
)

eps <- 0.001

turkish_newdat_deriv_1 <- turkish_newdat_deriv %>%
  mutate(log_segment_dur_uttr = log_segment_dur_uttr - (eps/2)
  )
turkish_newdat_deriv_2 <- turkish_newdat_deriv %>%
  mutate(log_segment_dur_uttr = log_segment_dur_uttr + (eps/2)
  )

X0 <- predict(turkish_ctype_mod, 
              turkish_newdat_deriv_1, type = 'lpmatrix', 
              exclude=c("s(log_segment_dur_uttr,languageSegtype)",
                           "s(log_segment_dur_uttr,speaker_f)")
              )
X1 <- predict(turkish_ctype_mod, 
              turkish_newdat_deriv_2, type = 'lpmatrix', 
              exclude=c("s(log_segment_dur_uttr,languageSegtype)",
                           "s(log_segment_dur_uttr,speaker_f)")
              )

# finite difference approximation of first derivative
# the design matrix
Xp <- (X1 - X0) / eps
first_deriv <- Xp %*% coef(turkish_ctype_mod)

turkish_newdat_deriv$derivative <- first_deriv
ctype_eff_sizes <- turkish_newdat_deriv %>%
  group_by(segment_type_f) %>%
  summarise(eff_size = mean(derivative)) %>%
  ungroup() %>%
  arrange(desc(eff_size))

ctype_eff_sizes
```

It's all a bit odd... Quite possibly a data quality issue!

Looking at Olivia's checking results
```{r}
df_check <- read_csv("../data/spot_checking.csv")
unique(df_check$PHONE_ALIGNMENT)
unique(df_check$LANGUAGE)

df_check <- df_check %>%
  group_by(LANGUAGE, SPEAKER, PHONE_ALIGNMENT) %>%
  summarize(N = n())

df_check %>%
  filter(PHONE_ALIGNMENT == "OK") %>%
  ggplot(aes(x = LANGUAGE, y = N, color = LANGUAGE)) +
  ggbeeswarm::geom_beeswarm() +
  #geom_jitter(width = 0.1) +
  coord_flip()
```